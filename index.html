<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ø–ª–∞–Ω—à–µ—Ç–æ–≤ ‚Äî ONNX Web</title>
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
  <style>
    :root{color-scheme:dark}
    *{box-sizing:border-box}
    body{margin:0;background:#0f1115;color:#e6e6e6;font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
    .wrap{max-width:780px;margin:0 auto;padding:16px}
    h1{font-size:20px;margin:8px 0 14px}
    .card{background:#171a21;border:1px solid #262a33;border-radius:14px;padding:14px;box-shadow:0 4px 20px rgba(0,0,0,.25)}
    video{width:100%;max-height:60vh;border-radius:12px;background:#000}
    .controls{display:flex;gap:12px;flex-wrap:wrap;margin:12px 0}
    button{padding:10px 16px;border-radius:10px;border:1px solid #2b3140;background:#222a36;color:#fff;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    #result{font-size:18px;margin:8px 0 2px}
    #sub{opacity:.8;font-size:14px;margin-bottom:6px}
    .pill{display:inline-block;border:1px solid #2b3140;border-radius:999px;padding:4px 10px;margin-right:6px;margin-top:6px;font-size:13px}
    .muted{opacity:.7}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .footer{opacity:.6;font-size:12px;margin-top:14px}
    pre{white-space:pre-wrap;word-break:break-word;background:#11151c;border:1px solid #283041;padding:10px;border-radius:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üì∑ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ø–ª–∞–Ω—à–µ—Ç–æ–≤ (ONNXRuntime Web)</h1>

    <div class="card">
      <video id="video" playsinline muted></video>

      <div class="controls">
        <button id="btnStart">–°—Ç–∞—Ä—Ç –∫–∞–º–µ—Ä—ã</button>
        <button id="btnStop" disabled>–°—Ç–æ–ø</button>
        <button id="btnFlip">–ü–æ–º–µ–Ω—è—Ç—å –∫–∞–º–µ—Ä—É</button>
      </div>

      <div id="result">–ì–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É‚Ä¶</div>
      <div id="sub" class="muted">–ó–∞–≥—Ä—É–∑–∏—Ç—Å—è –º–æ–¥–µ–ª—å –∏ –∫–∞—Ä—Ç–∞ –∫–ª–∞—Å—Å–æ–≤.</div>

      <div class="row">
        –¢–æ–ø-3:
        <span id="topk"></span>
      </div>

      <details style="margin-top:10px">
        <summary class="muted">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</summary>
        <pre id="diag"></pre>
      </details>

      <div class="footer">
        –°–æ–≤–µ—Ç—ã: –Ω—É–∂–µ–Ω HTTPS (GitHub Pages –ø–æ–¥–æ–π–¥—ë—Ç). –ù–∞ iOS –∫–∞–º–µ—Ä–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞.
      </div>
    </div>
  </div>

<script>
/** ======== –ù–ê–°–¢–†–û–ô–ö–ò –ü–£–¢–ï–ô ======== */
const MODEL_URL = 'web_model/model.onnx';
const MAP_URL   = 'class_mapping.json';

/** ======== –ì–õ–û–ë–ê–õ ======== */
const INPUT_SIZE = 224;                 // –ø–æ–¥–≥–æ–Ω –ø–æ–¥ —Ç–≤–æ—é –º–æ–¥–µ–ª—å
const LOOP_INTERVAL_MS = 150;           // —á–∞—Å—Ç–æ—Ç–∞ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞
let session = null, mapping = null;
let video = null, stream = null;
let usingBack = true;
let rafId = null, lastTs = 0;
let INPUT_NAME = null, OUTPUT_NAME = null;
let useNCHW = false; // –∞–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–∏–º –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏

/** ======== –£–¢–ò–õ–ò–¢–´ ======== */
const $ = s => document.querySelector(s);
const setText = (id, t) => document.getElementById(id).innerText = t;

function logDiag(obj) {
  const el = document.getElementById('diag');
  el.textContent += (typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2)) + '\n';
}

/** ======== –ó–ê–ì–†–£–ó–ö–ê –ú–û–î–ï–õ–ò –ò –ú–ê–ü–ü–ò–ù–ì–ê ======== */
async function loadAll(){
  setText('result','–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏‚Ä¶');
  session = await ort.InferenceSession.create(MODEL_URL, {
    executionProviders: ['wasm'], // –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å ['webgl'] –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
    graphOptimizationLevel: 'all'
  });

  // –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –≤—Ö–æ–¥–∞
  INPUT_NAME = session.inputNames[0];
  OUTPUT_NAME = session.outputNames[0];
  const metaIn = session.inputMetadata[INPUT_NAME];
  const dims = metaIn.dimensions; // –Ω–∞–ø—Ä–∏–º–µ—Ä, [1,224,224,3] –∏–ª–∏ [1,3,224,224]
  useNCHW = (dims && dims.length === 4 && dims[1] === 3);
  logDiag({inputName: INPUT_NAME, inputDims: dims, useNCHW});

  mapping = await fetch(MAP_URL).then(r=>r.json());
  setText('result','–ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ù–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç –∫–∞–º–µ—Ä—ã¬ª.');
  setText('sub', `–í—Ö–æ–¥: ${INPUT_SIZE}√ó${INPUT_SIZE}, –∫–ª–∞—Å—Å–æ–≤: ${Object.keys(mapping).length} ‚Ä¢ –§–æ—Ä–º–∞—Ç: ${useNCHW?'NCHW':'NHWC'}`);
}

/** ======== –ö–ê–ú–ï–†–ê ======== */
async function startCamera(){
  if(stream) await stopCamera();
  const constraints = { video: { facingMode: usingBack ? { ideal: 'environment' } : 'user' }, audio: false };
  stream = await navigator.mediaDevices.getUserMedia(constraints);
  video = document.getElementById('video');
  video.srcObject = stream;
  video.muted = true;
  await video.play();
}

async function stopCamera(){
  if(stream){ for(const t of stream.getTracks()) t.stop(); }
  stream = null;
  if(video) video.srcObject = null;
}

/** ======== –ü–†–ï–ü–†–û–¶–ï–°–° ======== */
function preprocessToTensor(v){
  const W = INPUT_SIZE, H = INPUT_SIZE;
  const cvs = document.createElement('canvas');
  cvs.width = W; cvs.height = H;
  const ctx = cvs.getContext('2d', { willReadFrequently: true });
  ctx.drawImage(v, 0, 0, W, H);
  const { data } = ctx.getImageData(0, 0, W, H);

  const wh = W * H;
  if (useNCHW) {
    // [1, 3, H, W]
    const floats = new Float32Array(wh * 3);
    for (let i=0,p=0;i<wh;i++){
      const r=data[p++], g=data[p++], b=data[p++]; p++; // A
      floats[i]       = (r/127.5 - 1);
      floats[i+wh]    = (g/127.5 - 1);
      floats[i+2*wh]  = (b/127.5 - 1);
    }
    return new ort.Tensor('float32', floats, [1,3,H,W]);
  } else {
    // [1, H, W, 3]
    const floats = new Float32Array(wh * 3);
    for (let i=0,p=0,q=0;i<wh;i++){
      const r=data[p++], g=data[p++], b=data[p++]; p++;
      floats[q++] = (r/127.5 - 1);
      floats[q++] = (g/127.5 - 1);
      floats[q++] = (b/127.5 - 1);
    }
    return new ort.Tensor('float32', floats, [1,H,W,3]);
  }
}

/** ======== –ò–ù–§–ï–†–ï–ù–° ======== */
function topkSoftmax(logits, k=3){
  let maxL = -Infinity;
  for (let i=0;i<logits.length;i++) if (logits[i]>maxL) maxL = logits[i];
  let sum = 0; const exps = new Float32Array(logits.length);
  for (let i=0;i<logits.length;i++){ const e = Math.exp(logits[i]-maxL); exps[i]=e; sum+=e; }
  const probs = new Float32Array(logits.length);
  for (let i=0;i<logits.length;i++) probs[i] = exps[i]/sum;
  const idxs = [...probs.keys()].sort((a,b)=>probs[b]-probs[a]);
  return {
    top1Idx: idxs[0],
    top1Prob: probs[idxs[0]],
    top3: idxs.slice(0,k).map(i=>({idx:i, prob:probs[i]}))
  };
}

async function predictLoop(ts){
  if (!lastTs || ts - lastTs >= LOOP_INTERVAL_MS) {
    lastTs = ts;
    try {
      const x = preprocessToTensor(video);
      const outMap = await session.run({ [INPUT_NAME]: x });
      const logits = outMap[OUTPUT_NAME].data;
      const { top1Idx, top1Prob, top3 } = topkSoftmax(logits, 3);

      const name = mapping[String(top1Idx)] ?? `class_${top1Idx}`;
      setText('result', `üß© ${name} (${(top1Prob*100).toFixed(1)}%)`);
      setText('sub', `–ö–ª–∞—Å—Å #${top1Idx} ‚Ä¢ –§–æ—Ä–º–∞—Ç –≤—Ö–æ–¥–∞: ${useNCHW?'NCHW':'NHWC'}`);
      document.getElementById('topk').innerHTML = top3.map(
        ({idx, prob}) => `<span class="pill">${mapping[String(idx)] ?? 'class_'+idx} ‚Äî ${(prob*100).toFixed(1)}%</span>`
      ).join(' ');
    } catch (e) {
      setText('result', '–û—à–∏–±–∫–∞ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞');
      document.getElementById('sub').innerText = e && e.message ? e.message : String(e);
      logDiag(e?.stack || String(e));
    }
  }
  rafId = requestAnimationFrame(predictLoop);
}

/** ======== UI ======== */
document.getElementById('btnStart').addEventListener('click', async ()=>{
  try{
    $('#btnStart').disabled = true;
    await loadAll();
    await startCamera();
    $('#btnStop').disabled = false;
    setText('result','–ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞. –†–∞—Å–ø–æ–∑–Ω–∞—ë–º‚Ä¶');
    rafId = requestAnimationFrame(predictLoop);
  }catch(e){
    $('#btnStart').disabled = false;
    setText('result','–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞');
    setText('sub', e?.message || String(e));
    logDiag(e?.stack || String(e));
  }
});

document.getElementById('btnStop').addEventListener('click', async ()=>{
  try{
    if (rafId) cancelAnimationFrame(rafId);
    await stopCamera();
    $('#btnStop').disabled = true;
    $('#btnStart').disabled = false;
    setText('result','–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.');
  }catch(e){
    setText('result','–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏');
    setText('sub', e?.message || String(e));
  }
});

document.getElementById('btnFlip').addEventListener('click', async ()=>{
  usingBack = !usingBack;
  if (stream){ await startCamera(); }
});
</script>
</body>
</html>
