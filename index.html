<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ø–ª–∞–Ω—à–µ—Ç–æ–≤ ‚Äî ONNX Web v auto roi</title>
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
  <!-- OpenCV.js –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ –∫–≤–∞–¥—Ä–∞—Ç–æ–≤ –∏ warp -->
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <div class="wrap">
    <h1>üì∑ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ø–ª–∞–Ω—à–µ—Ç–æ–≤ (ONNXRuntime Web)</h1>

    <div class="card">
      <div class="video-wrap">
        <video id="video" playsinline muted></video>
        <canvas id="overlay"></canvas>
      </div>

      <div class="controls">
        <button id="btnStart">–°—Ç–∞—Ä—Ç –∫–∞–º–µ—Ä—ã</button>
        <button id="btnStop" disabled>–°—Ç–æ–ø</button>
        <button id="btnFlip">–ü–æ–º–µ–Ω—è—Ç—å –∫–∞–º–µ—Ä—É</button>
      </div>

      <div class="settings">
        <div class="row">
          <label>–ö–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ:</label>
          <select id="selCrop">
            <option value="full">Full frame (resize)</option>
            <option value="center">Center-crop (square)</option>
            <option value="auto" selected>Auto-ROI (–¥–µ—Ç–µ–∫—Ç–æ—Ä)</option>
          </select>
        </div>
        <div class="row">
          <label>–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è:</label>
          <select id="selNorm">
            <option value="neg1to1" selected>[-1, 1]</option>
            <option value="zero1">[0, 1]</option>
            <option value="imagenet">ImageNet mean/std</option>
          </select>
        </div>
        <div class="row">
          <label>ROI pad: <span id="valPad">0.08</span></label>
          <input id="rngPad" type="range" min="0" max="0.30" step="0.01" value="0.08" />
        </div>
        <div class="row">
          <label>EMA: <span id="valEma">0.35</span></label>
          <input id="rngEma" type="range" min="0" max="0.95" step="0.01" value="0.35" />
        </div>
      </div>

      <div id="result">–ì–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É‚Ä¶</div>
      <div id="sub" class="muted">–ó–∞–≥—Ä—É–∑–∏—Ç—Å—è –º–æ–¥–µ–ª—å –∏ –∫–∞—Ä—Ç–∞ –∫–ª–∞—Å—Å–æ–≤.</div>
      <div id="progressWrap"><div id="progress"></div></div>
      <div class="topk-row"><span class="label">–¢–æ–ø-3:</span><span id="topk"></span></div>

      <details>
        <summary>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</summary>
        <pre id="diag"></pre>
      </details>

      <div class="footer">
        –ù—É–∂–µ–Ω HTTPS (GitHub Pages –ø–æ–¥–æ–π–¥—ë—Ç). –ù–∞ iOS –∫–∞–º–µ—Ä–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞.
      </div>
    </div>
  </div>

  <script type="module" src="./src/main.js"></script>
  
  <!-- –ù–∞—à –ª—ë–≥–∫–∏–π –ø–∞–π–ø–ª–∞–π–Ω Auto-ROI -->
  <script src="src/pipeline-auto-roi.js"></script>

  <style>
    /* –ü—Ä—è—á–µ–º —Å—Ç–∞—Ä—ã–µ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –ø–∞–Ω–µ–ª–∏ */
    .devpanel, .controls, .long-ui { display: none !important; }
  
    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–∏–¥–µ–æ –∏ –æ–≤–µ—Ä–ª–µ—è */
    #arch-app { position: relative; display: inline-block; }
    #overlay, #hud { position: absolute; left: 0; top: 0; pointer-events: none; }
  
    /* –ú–∏–Ω–∏-–±–µ–π–¥–∂ –≤ —É–≥–ª—É (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π UI) */
    .badge {
      position: absolute; left: 12px; top: 12px;
      background: rgba(0,0,0,0.55); color: #fff; padding: 6px 10px;
      border-radius: 6px; font: 14px/1.2 system-ui, sans-serif;
    }
  
    /* –ö–Ω–æ–ø–∫–∞ Debug */
    #debugToggle {
      position: fixed; right: 14px; bottom: 14px; z-index: 1000;
      background: #111; color: #fff; border: 0; padding: 8px 12px;
      border-radius: 8px; cursor: pointer;
    }
  
    /* Debug-–ø–∞–Ω–µ–ª—å */
    #debugPanel {
      position: fixed; right: 14px; bottom: 56px; width: 360px; max-height: 60vh;
      overflow: auto; background: rgba(18,18,18,0.96); color: #dcdcdc;
      border: 1px solid #333; border-radius: 10px; padding: 10px 12px;
      font: 12px/1.45 ui-monospace, SFMono-Regular, Menlo, monospace;
      display: none; z-index: 1000;
    }
    #debugPanel pre { white-space: pre-wrap; margin: 0; }
    .roi-strip { display: flex; gap: 6px; margin-top: 8px; }
    .roi-strip canvas { width: 80px; height: 80px; border: 1px solid #333; }
  </style>
  
  <div id="arch-app">
    <!-- –∑–¥–µ—Å—å —É–∂–µ –µ—Å—Ç—å —Ç–≤–æ—ë <video> ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞–µ–º —Ä–∞–∑–º–µ—Ç–∫—É; –ø—Ä–æ—Å—Ç–æ –∫–ª–∞–¥—ë–º –ø–æ–≤–µ—Ä—Ö –∫–∞–Ω–≤–∞—Å—ã -->
    <canvas id="overlay"></canvas>
    <div id="hud" class="badge">‚Ä¶</div>
  </div>
  
  <button id="debugToggle" title="D">Debug</button>
  <div id="debugPanel">
    <div id="debugMetrics"></div>
    <div class="roi-strip" id="roiStrip"></div>
  </div>
  
  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –ø–∞–π–ø–ª–∞–π–Ω –ø–æ–≤–µ—Ä—Ö —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–¥–∞ -->
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
  <script src="src/pipeline-auto-roi.js"></script>
</body>
</html>