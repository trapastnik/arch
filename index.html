<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ø–ª–∞–Ω—à–µ—Ç–æ–≤ (ONNXRuntime Web) v2</title>
  <!-- ONNXRuntime Web -->
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
  <style>
    :root{color-scheme:dark}
    body{margin:0;background:#0f1115;color:#e6e6e6;font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif}
    .wrap{max-width:680px;margin:0 auto;padding:16px}
    h1{font-size:20px;margin:8px 0 12px}
    .card{background:#171a21;border:1px solid #262a33;border-radius:14px;padding:14px;box-shadow:0 4px 20px rgba(0,0,0,.25)}
    video{width:100%;max-height:60vh;border-radius:12px;background:#000}
    .controls{display:flex;gap:12px;flex-wrap:wrap;margin:12px 0}
    button{padding:10px 16px;border-radius:10px;border:1px solid #2b3140;background:#222a36;color:#fff;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    #result{font-size:18px;margin:8px 0 2px}
    #sub{opacity:.8;font-size:14px}
    .pill{display:inline-block;border:1px solid #2b3140;border-radius:999px;padding:4px 10px;margin-right:6px;margin-top:6px;font-size:13px}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .muted{opacity:.7}
    .footer{opacity:.6;font-size:12px;margin-top:14px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üì∑ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ø–ª–∞–Ω—à–µ—Ç–æ–≤ (ONNX Web)</h1>

    <div class="card">
      <video id="video" playsinline muted></video>

      <div class="controls">
        <button id="btnStart">–°—Ç–∞—Ä—Ç –∫–∞–º–µ—Ä—ã</button>
        <button id="btnStop" disabled>–°—Ç–æ–ø</button>
        <button id="btnFlip">–ü–æ–º–µ–Ω—è—Ç—å –∫–∞–º–µ—Ä—É</button>
      </div>

      <div id="result">–ì–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É‚Ä¶</div>
      <div id="sub" class="muted">–ó–∞–≥—Ä—É–∑–∏—Ç—Å—è –º–æ–¥–µ–ª—å –∏ –∫–∞—Ä—Ç–∞ –∫–ª–∞—Å—Å–æ–≤.</div>

      <div class="row">
        –¢–æ–ø-3:
        <span id="topk"></span>
      </div>

      <div class="footer">
        –°–æ–≤–µ—Ç—ã: –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –Ω—É–∂–µ–Ω HTTPS (GitHub Pages –ø–æ–¥–æ–π–¥—ë—Ç). –ù–∞ iOS –∫–∞–º–µ—Ä–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞.
      </div>
    </div>
  </div>

<script>
/** ======== –ù–ê–°–¢–†–û–ô–ö–ò ======== */
const MODEL_URL = 'web_model/model.onnx';
const MAP_URL   = 'class_mapping.json';
const INPUT_SIZE = 224;            // —Ä–∞–∑–º–µ—Ä, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ä–µ—Å–∞–π–∑–∏–º –∫–∞–¥—Ä
const LOOP_INTERVAL_MS = 150;      // —á–∞—Å—Ç–æ—Ç–∞ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞ (~6-7 FPS)
const USE_NCHW = true;             // tf2onnx –æ–±—ã—á–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç NCHW [1,3,H,W]
// –ï—Å–ª–∏ —Ç–≤–æ–π ONNX –æ–∂–∏–¥–∞–µ—Ç NHWC ‚Äî –ø–æ—Å—Ç–∞–≤—å false –∏ —Å–º. —Ñ—É–Ω–∫—Ü–∏—é preprocessToTensor

/** ======== –ì–õ–û–ë–ê–õ ======== */
let session = null, mapping = null;
let video = null, stream = null;
let usingBack = true;
let rafId = null;
let lastTs = 0;

/** ======== –ó–ê–ì–†–£–ó–ö–ê –ú–û–î–ï–õ–ò –ò –ú–ê–ü–ü–ò–ù–ì–ê ======== */
async function loadAll(){
  document.getElementById('result').innerText = '–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏‚Ä¶';
  session = await ort.InferenceSession.create(MODEL_URL, {
    executionProviders: ['wasm'], // –º–æ–∂–Ω–æ ['webgl'] –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è (–Ω–µ –≤–µ–∑–¥–µ —Å—Ç–∞–±–∏–ª–µ–Ω)
    graphOptimizationLevel: 'all'
  });
  mapping = await fetch(MAP_URL).then(r=>r.json());
  document.getElementById('result').innerText = '–ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ù–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç –∫–∞–º–µ—Ä—ã¬ª.';
  document.getElementById('sub').innerText = `–í—Ö–æ–¥: ${INPUT_SIZE}√ó${INPUT_SIZE}, –∫–ª–∞—Å—Å–æ–≤: ${Object.keys(mapping).length}`;
}

/** ======== –ö–ê–ú–ï–†–ê ======== */
async function startCamera(){
  if(stream) await stopCamera();
  const constraints = {
    video: {
      facingMode: usingBack ? { ideal: 'environment' } : 'user'
    },
    audio: false
  };
  stream = await navigator.mediaDevices.getUserMedia(constraints);
  video = document.getElementById('video');
  video.srcObject = stream;
  video.muted = true;
  await video.play();
}

async function stopCamera(){
  if(stream){
    for(const t of stream.getTracks()) t.stop();
  }
  stream = null;
  if(video) video.srcObject = null;
}

/** ======== –ü–†–ï–ü–†–û–¶–ï–°–° ======== */
function preprocessToTensor(v){
  // –ö–∞–¥—Ä -> 224√ó224 -> float32 -> –Ω–æ—Ä–º–∏—Ä–æ–≤–∫–∞ [-1,1]
  const cvs = document.createElement('canvas');
  cvs.width = INPUT_SIZE; cvs.height = INPUT_SIZE;
  const ctx = cvs.getContext('2d', { willReadFrequently: true });
  ctx.drawImage(v, 0, 0, INPUT_SIZE, INPUT_SIZE);
  const { data } = ctx.getImageData(0, 0, INPUT_SIZE, INPUT_SIZE);

  const wh = INPUT_SIZE * INPUT_SIZE;
  if (USE_NCHW) {
    // R –±–ª–æ–∫, –ø–æ—Ç–æ–º G, –ø–æ—Ç–æ–º B: [1,3,H,W]
    const floats = new Float32Array(wh * 3);
    for (let i = 0, p = 0; i < wh; i++){
      const r = data[p++], g = data[p++], b = data[p++]; p++; // skip A
      floats[i]        = (r / 127.5 - 1);
      floats[i + wh]   = (g / 127.5 - 1);
      floats[i + 2*wh] = (b / 127.5 - 1);
    }
    return new ort.Tensor('float32', floats, [1, 3, INPUT_SIZE, INPUT_SIZE]);
  } else {
    // NHWC: RGBRGB‚Ä¶ –≤ [1,H,W,3]
    const floats = new Float32Array(wh * 3);
    for (let i = 0, p = 0, q = 0; i < wh; i++){
      const r = data[p++], g = data[p++], b = data[p++]; p++;
      floats[q++] = (r / 127.5 - 1);
      floats[q++] = (g / 127.5 - 1);
      floats[q++] = (b / 127.5 - 1);
    }
    return new ort.Tensor('float32', floats, [1, INPUT_SIZE, INPUT_SIZE, 3]);
  }
}

/** ======== –ò–ù–§–ï–†–ï–ù–° –¶–ò–ö–õ ======== */
async function predictLoop(ts){
  if (!lastTs || ts - lastTs >= LOOP_INTERVAL_MS) {
    lastTs = ts;
    try {
      const x = preprocessToTensor(video);
      const inputName = session.inputNames[0];
      const outMap = await session.run({ [inputName]: x });
      const outName = session.outputNames[0];
      const logits = outMap[outName].data; // Float32Array
      const { top1Idx, top1Prob, top3 } = topkSoftmax(logits, 3);

      const name = mapping[String(top1Idx)] ?? `class_${top1Idx}`;
      document.getElementById('result').innerText = `üß© ${name} (${(top1Prob*100).toFixed(1)}%)`;
      document.getElementById('sub').innerText = `–ö–ª–∞—Å—Å #${top1Idx}`;
      document.getElementById('topk').innerHTML = top3.map(
        ({idx, prob}) => `<span class="pill">${mapping[String(idx)] ?? 'class_'+idx} ‚Äî ${(prob*100).toFixed(1)}%</span>`
      ).join(' ');
    } catch (e) {
      document.getElementById('result').innerText = '–û—à–∏–±–∫–∞ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞: ' + e.message;
    }
  }
  rafId = requestAnimationFrame(predictLoop);
}

function topkSoftmax(logits, k=3){
  // softmax + top-k –≤—Ä—É—á–Ω—É—é (–±–µ–∑ —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫)
  let maxLogit = -Infinity;
  for (let i=0;i<logits.length;i++) if (logits[i] > maxLogit) maxLogit = logits[i];
  let sum = 0;
  const exps = new Float32Array(logits.length);
  for (let i=0;i<logits.length;i++){ const e = Math.exp(logits[i] - maxLogit); exps[i] = e; sum += e; }

  const probs = new Float32Array(logits.length);
  for (let i=0;i<logits.length;i++) probs[i] = exps[i] / sum;

  const idxs = [...probs.keys()];
  idxs.sort((a,b)=>probs[b]-probs[a]);
  const top1Idx = idxs[0], top1Prob = probs[top1Idx];
  const top3 = idxs.slice(0, k).map(i=>({idx:i, prob:probs[i]}));
  return { top1Idx, top1Prob, top3 };
}

/** ======== UI –ö–ù–û–ü–ö–ò ======== */
document.getElementById('btnStart').addEventListener('click', async ()=>{
  try{
    document.getElementById('btnStart').disabled = true;
    await loadAll();
    await startCamera();
    document.getElementById('btnStop').disabled = false;
    document.getElementById('result').innerText = '–ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞. –†–∞—Å–ø–æ–∑–Ω–∞—ë–º‚Ä¶';
    rafId = requestAnimationFrame(predictLoop);
  }catch(e){
    document.getElementById('result').innerText = '–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: ' + e.message;
    document.getElementById('btnStart').disabled = false;
  }
});

document.getElementById('btnStop').addEventListener('click', async ()=>{
  try{
    if (rafId) cancelAnimationFrame(rafId);
    await stopCamera();
    document.getElementById('btnStop').disabled = true;
    document.getElementById('btnStart').disabled = false;
    document.getElementById('result').innerText = '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.';
  }catch(e){
    document.getElementById('result').innerText = '–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: ' + e.message;
  }
});

document.getElementById('btnFlip').addEventListener('click', async ()=>{
  usingBack = !usingBack;
  if (stream){
    await startCamera();
  }
});
</script>
</body>
</html>