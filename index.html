<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"
  />
  <title>–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ø–ª–∞–Ω—à–µ—Ç–æ–≤ ‚Äî ONNX Web</title>
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: #0f1115;
      color: #e6e6e6;
      font: 15px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }
    .wrap {
      max-width: 720px;
      margin: 0 auto;
      padding: 10px 12px;
    }
    h1 {
      font-size: 17px;
      font-weight: 600;
      margin: 0 0 8px;
      text-align: left;
    }
    .card {
      background: #171a21;
      border: 1px solid #262a33;
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 4px 18px rgba(0,0,0,.25);
    }
    /* –í–∏–¥–µ–æ –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ, —á—Ç–æ–±—ã –≤–µ—Å—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤–ª–µ–∑ –±–µ–∑ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
    .video-wrap {
      position: relative;
      width: 100%;
      border-radius: 10px;
      overflow: hidden;
      background: #000;
    }
    video {
      display: block;
      width: 100%;
      max-height: 50vh; /* –∫–ª—é—á: –Ω–µ –±–æ–ª—å—à–µ –ø–æ–ª–æ–≤–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞ */
      border-radius: 10px;
      background: #000;
    }
    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 8px 0 6px;
    }
    button {
      padding: 8px 12px;
      border-radius: 9px;
      border: 1px solid #2b3140;
      background: #222a36;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
    }
    button[disabled] { opacity: .6; cursor: not-allowed; }
    #result { font-size: 16px; margin: 6px 0 2px; }
    #sub { opacity: .8; font-size: 13px; margin-bottom: 4px; min-height: 18px; }

    /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */
    #progressWrap {
      display: none;
      height: 6px;
      background: #11151c;
      border: 1px solid #283041;
      border-radius: 999px;
      overflow: hidden;
      margin: 4px 0 6px;
    }
    #progress { height: 100%; width: 0%; background: #4a90e2; }

    /* –¢–æ–ø-3 ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ –ø–∏–ª—é–ª–∏ —Å –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏/—Å–∫—Ä–æ–ª–ª–æ–º –ø–æ X, –µ—Å–ª–∏ –Ω–µ –≤–ª–µ–∑–∞–µ—Ç */
    .topk-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 2px;
    }
    .label { font-size: 13px; opacity: .85; white-space: nowrap; }
    .pill {
      display: inline-block;
      border: 1px solid #2b3140;
      border-radius: 999px;
      padding: 3px 8px;
      white-space: nowrap;
      font-size: 12px;
      margin-right: 4px;
    }

    /* –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–≤—ë—Ä–Ω—É—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏ –∫–æ–º–ø–∞–∫—Ç–Ω–∞ */
    details { margin-top: 6px; }
    details > summary { list-style: none; cursor: pointer; font-size: 12px; opacity: .75; }
    details > summary::-webkit-details-marker { display: none; }
    pre {
      white-space: pre-wrap;
      word-break: break-word;
      background: #11151c;
      border: 1px solid #283041;
      padding: 8px;
      border-radius: 8px;
      font-size: 12px;
      max-height: 22vh;
      overflow: auto;
      margin-top: 6px;
    }

    .footer {
      opacity: .6;
      font-size: 11.5px;
      margin-top: 8px;
    }

    /* –ß—É—Ç—å —É–∂–∞—Ç—å –Ω–∞ –æ—á–µ–Ω—å —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
    @media (max-width: 390px) {
      #result { font-size: 15px; }
      button { font-size: 13px; padding: 7px 10px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üì∑ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ø–ª–∞–Ω—à–µ—Ç–æ–≤ (ONNXRuntime Web)</h1>

    <div class="card">
      <div class="video-wrap">
        <video id="video" playsinline muted></video>
      </div>

      <div class="controls">
        <button id="btnStart">–°—Ç–∞—Ä—Ç –∫–∞–º–µ—Ä—ã</button>
        <button id="btnStop" disabled>–°—Ç–æ–ø</button>
        <button id="btnFlip">–ü–æ–º–µ–Ω—è—Ç—å –∫–∞–º–µ—Ä—É</button>
      </div>

      <div id="result">–ì–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É‚Ä¶</div>
      <div id="sub" class="muted">–ó–∞–≥—Ä—É–∑–∏—Ç—Å—è –º–æ–¥–µ–ª—å –∏ –∫–∞—Ä—Ç–∞ –∫–ª–∞—Å—Å–æ–≤.</div>

      <div id="progressWrap"><div id="progress"></div></div>

      <div class="topk-row">
        <span class="label">–¢–æ–ø-3:</span>
        <span id="topk"></span>
      </div>

      <details>
        <summary>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</summary>
        <pre id="diag"></pre>
      </details>

      <div class="footer">
        –ù—É–∂–µ–Ω HTTPS (GitHub Pages –ø–æ–¥–æ–π–¥—ë—Ç). –ù–∞ iOS –∫–∞–º–µ—Ä–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞. –î–ª—è —Ç–æ—á–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–≤–∞—Ç–Ω—É—é –≤–∫–ª–∞–¥–∫—É –∏–ª–∏ ¬´–∂—ë—Å—Ç–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ¬ª.
      </div>
    </div>
  </div>

<script>
/** ========= –ü–£–¢–ò ========= */
const MODEL_URL = 'web_model/model.onnx';
const MAP_URL   = 'class_mapping.json';

/** ========= –ì–õ–û–ë–ê–õ ========= */
const INPUT_SIZE = 224;
const LOOP_INTERVAL_MS = 150;

let session = null, mapping = null;
let video = null, stream = null;
let usingBack = true;
let rafId = null, lastTs = 0;
let INPUT_NAME = null, OUTPUT_NAME = null;
let useNCHW = false; // –∞–≤—Ç–æ-–¥–µ—Ç–µ–∫—Ç; –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é NHWC

/** ========= –ú–ï–õ–û–ß–ò ========= */
const $ = s => document.querySelector(s);
const setText = (id, t) => document.getElementById(id).innerText = t;
function logDiag(obj){
  const el = document.getElementById('diag');
  el.textContent += (typeof obj==='string' ? obj : JSON.stringify(obj, null, 2)) + '\n';
}
function setStatus(txt, pct=null){
  setText('result', txt);
  const bar = document.getElementById('progress');
  const wrap = document.getElementById('progressWrap');
  if (pct === null){ wrap.style.display = 'none'; }
  else { wrap.style.display = 'block'; bar.style.width = `${Math.max(0, Math.min(100, Math.round(pct*100)))}%`; }
}

/** ========= –ó–ê–ì–†–£–ó–ö–ê –° –ü–†–û–ì–†–ï–°–°–û–ú ========= */
async function fetchModelWithProgress(url, onProgress){
  const resp = await fetch(url);
  if (!resp.ok) throw new Error(`HTTP ${resp.status} while fetching model`);
  const total = +resp.headers.get('Content-Length') || 0;
  const reader = resp.body?.getReader?.();
  if (!reader) {
    const ab = await resp.arrayBuffer();
    onProgress && onProgress(1);
    return new Uint8Array(ab);
  }
  const chunks = [];
  let rec = 0;
  for(;;){
    const {done, value} = await reader.read();
    if (done) break;
    chunks.push(value);
    rec += value.byteLength;
    if (total) onProgress && onProgress(rec/total);
  }
  const blob = new Blob(chunks);
  const ab = await blob.arrayBuffer();
  onProgress && onProgress(1);
  return new Uint8Array(ab);
}

/** ========= –ú–û–î–ï–õ–¨ + –ú–ê–ü–ü–ò–ù–ì ========= */
async function loadAll(){
  setStatus('–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–Ω—Ç–∞–π–º–∞‚Ä¶');
  await new Promise(r=>setTimeout(r, 40)); // –¥–∞—Ç—å –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å—Å—è

  setStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏‚Ä¶', 0);
  const modelBytes = await fetchModelWithProgress(MODEL_URL, p=>{
    setStatus(`–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏‚Ä¶ ${Math.round(p*100)}%`, p);
  });

  setStatus('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏‚Ä¶');
  session = await ort.InferenceSession.create(modelBytes, {
    executionProviders: ['wasm'],
    graphOptimizationLevel: 'all'
  });

  INPUT_NAME  = session.inputNames?.[0] ?? null;
  OUTPUT_NAME = session.outputNames?.[0] ?? null;

  // –ë–µ–∑–æ–ø–∞—Å–Ω–æ —á–∏—Ç–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  let dims = null;
  try {
    const meta = session.inputMetadata;
    if (meta){
      if (typeof meta.get === 'function' && INPUT_NAME){
        dims = meta.get(INPUT_NAME)?.dimensions ?? null;
      } else if (INPUT_NAME && meta[INPUT_NAME]){
        dims = meta[INPUT_NAME].dimensions ?? null;
      }
    }
  } catch(e){ logDiag('meta read error: ' + (e?.message || e)); }

  // –ê–≤—Ç–æ-–¥–µ—Ç–µ–∫—Ç: –≥–¥–µ ¬´3¬ª ‚Äî —Ç–∞–º –∫–∞–Ω–∞–ª; –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –¥–µ—Ñ–æ–ª—Ç NHWC
  useNCHW = (Array.isArray(dims) && dims.length===4 && dims[1]===3);
  logDiag({ inputName: INPUT_NAME, outputName: OUTPUT_NAME, inputDims: dims, useNCHW });

  setStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã –∫–ª–∞—Å—Å–æ–≤‚Ä¶');
  mapping = await fetch(MAP_URL).then(r=>r.json());

  // –õ—ë–≥–∫–∏–π –ø—Ä–æ–≥—Ä–µ–≤
  setStatus('–ü—Ä–æ–≥—Ä–µ–≤ –º–æ–¥–µ–ª–∏‚Ä¶');
  try{
    const W = INPUT_SIZE, H = INPUT_SIZE;
    const zeros = new Float32Array(W*H*3);
    const warm = useNCHW
      ? new ort.Tensor('float32', zeros, [1,3,H,W])
      : new ort.Tensor('float32', zeros, [1,H,W,3]);
    await session.run({ [INPUT_NAME]: warm });
  }catch(e){ logDiag('warmup: '+(e?.message||e)); }

  setStatus('–ú–æ–¥–µ–ª—å –≥–æ—Ç–æ–≤–∞. –ù–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç –∫–∞–º–µ—Ä—ã¬ª.', null);
  setText('sub', `–í—Ö–æ–¥: ${INPUT_SIZE}√ó${INPUT_SIZE}, –∫–ª–∞—Å—Å–æ–≤: ${Object.keys(mapping).length} ‚Ä¢ –§–æ—Ä–º–∞—Ç: ${useNCHW?'NCHW':'NHWC'}`);
}

/** ========= –ö–ê–ú–ï–†–ê ========= */
async function startCamera(){
  if(stream) await stopCamera();
  const constraints = { video: { facingMode: usingBack ? { ideal: 'environment' } : 'user' }, audio: false };
  stream = await navigator.mediaDevices.getUserMedia(constraints);
  video = document.getElementById('video');
  video.setAttribute('playsinline',''); // iOS –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –Ω–∞ –ø–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω
  video.srcObject = stream;
  video.muted = true;
  await video.play();
}

async function stopCamera(){
  if(stream){ for(const t of stream.getTracks()) t.stop(); }
  stream = null;
  if(video) video.srcObject = null;
}

/** ========= –ü–†–ï–ü–†–û–¶–ï–°–° ========= */
function preprocessToTensor(v){
  const W = INPUT_SIZE, H = INPUT_SIZE;
  const cvs = document.createElement('canvas');
  cvs.width = W; cvs.height = H;
  const ctx = cvs.getContext('2d', { willReadFrequently: true });
  ctx.drawImage(v, 0, 0, W, H);
  const { data } = ctx.getImageData(0, 0, W, H);
  const wh = W*H;

  if (useNCHW) {
    const floats = new Float32Array(wh*3);
    for (let i=0,p=0;i<wh;i++){
      const r=data[p++], g=data[p++], b=data[p++]; p++; // A
      floats[i]       = (r/127.5 - 1);
      floats[i+wh]    = (g/127.5 - 1);
      floats[i+2*wh]  = (b/127.5 - 1);
    }
    return new ort.Tensor('float32', floats, [1,3,H,W]);
  } else {
    const floats = new Float32Array(wh*3);
    for (let i=0,p=0,q=0;i<wh;i++){
      const r=data[p++], g=data[p++], b=data[p++]; p++;
      floats[q++] = (r/127.5 - 1);
      floats[q++] = (g/127.5 - 1);
      floats[q++] = (b/127.5 - 1);
    }
    return new ort.Tensor('float32', floats, [1,H,W,3]);
  }
}

/** ========= –ò–ù–§–ï–†–ï–ù–° ========= */
function topkSoftmax(logits, k=3){
  let maxL = -Infinity;
  for (let i=0;i<logits.length;i++) if (logits[i]>maxL) maxL = logits[i];
  let sum = 0; const exps = new Float32Array(logits.length);
  for (let i=0;i<logits.length;i++){ const e = Math.exp(logits[i]-maxL); exps[i]=e; sum+=e; }
  const probs = new Float32Array(logits.length);
  for (let i=0;i<logits.length;i++) probs[i] = exps[i]/sum;
  const idxs = [...probs.keys()].sort((a,b)=>probs[b]-probs[a]);
  return { top1Idx: idxs[0], top1Prob: probs[idxs[0]], top3: idxs.slice(0,k).map(i=>({idx:i, prob:probs[i]})) };
}

async function predictLoop(ts){
  if (!lastTs || ts - lastTs >= LOOP_INTERVAL_MS) {
    lastTs = ts;
    try {
      const x = preprocessToTensor(video);
      const out = await session.run({ [INPUT_NAME]: x });
      const logits = out[OUTPUT_NAME].data;
      const { top1Idx, top1Prob, top3 } = topkSoftmax(logits, 3);
      const name = mapping[String(top1Idx)] ?? `class_${top1Idx}`;
      setText('result', `üß© ${name} (${(top1Prob*100).toFixed(1)}%)`);
      setText('sub', `–ö–ª–∞—Å—Å #${top1Idx} ‚Ä¢ –§–æ—Ä–º–∞—Ç: ${useNCHW?'NCHW':'NHWC'}`);
      document.getElementById('topk').innerHTML = top3.map(
        ({idx, prob}) => `<span class="pill">${mapping[String(idx)] ?? 'class_'+idx} ‚Äî ${(prob*100).toFixed(1)}%</span>`
      ).join('');
    } catch (e) {
      setText('result','–û—à–∏–±–∫–∞ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞');
      setText('sub', e?.message || String(e));
      logDiag(e?.stack || String(e));
    }
  }
  rafId = requestAnimationFrame(predictLoop);
}

/** ========= UI ========= */
document.getElementById('btnStart').addEventListener('click', async ()=>{
  try{
    $('#btnStart').disabled = true;
    setStatus('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞‚Ä¶');
    await loadAll();
    await startCamera();
    $('#btnStop').disabled = false;
    setStatus('–ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞. –†–∞—Å–ø–æ–∑–Ω–∞—ë–º‚Ä¶', null);
    rafId = requestAnimationFrame(predictLoop);
  }catch(e){
    $('#btnStart').disabled = false;
    setText('result','–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞');
    setText('sub', e?.message || String(e));
    logDiag(e?.stack || String(e));
  }
});
document.getElementById('btnStop').addEventListener('click', async ()=>{
  if (rafId) cancelAnimationFrame(rafId);
  await stopCamera();
  $('#btnStop').disabled = true;
  $('#btnStart').disabled = false;
  setStatus('–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.', null);
});
document.getElementById('btnFlip').addEventListener('click', async ()=>{
  usingBack = !usingBack;
  if (stream){ await startCamera(); }
});
</script>
</body>
</html>
