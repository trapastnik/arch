name: build

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      PIP_NO_PYTHON_VERSION_WARNING: "1"
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Show env
        run: |
          python -V
          pip -V

      - name: Install pinned base (TensorFlow 2.12.x + NumPy<2)
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip setuptools wheel

          # Критичные пины для совместимости с TF 2.12 и старыми бинарями
          pip install \
            "numpy==1.23.5" \
            "h5py==3.10.0" \
            "protobuf==3.20.3" \
            "packaging==23.2" \
            "typing_extensions==4.5.0"

          # Сам TF и дружественные пакеты на совместимых версиях
          pip install \
            "tensorflow-cpu==2.12.0" \
            "tensorflow-estimator==2.12.0" \
            "tensorboard==2.12.3"

          # То, что иногда требует tfdf и пайплайн
          pip install \
            "pandas==2.0.3" \
            "wurlitzer==3.1.1"

          # Полезные аддоны без автоподтягивания конфликтующих зависимостей
          pip install --no-deps "tensorflow-hub==0.12.0" "tensorflow-decision-forests==1.4.0"

          python - <<'PY'
          import numpy, tensorflow as tf
          print("✅ Base OK  | NumPy:", numpy.__version__, "| TF:", tf.__version__)
          PY

      - name: Try TFJS Strategy A (4.11.0 + JAX pinned) → else Strategy B (4.10.0) → else Strategy C (4.8.0 no-JAX)
        run: |
          set -euxo pipefail

          # Чистим на всякий случай
          pip uninstall -y tensorflowjs jax jaxlib || true

          echo "=== Strategy A: TFJS 4.11.0 + JAX 0.4.26 + SciPy 1.11.4, при этом NumPy остаётся 1.23.5 ==="
          # Важно: не даём pipу утащить NumPy в 2.x — версии ниже совместимы и удовлетворяют jax
          pip install --upgrade --force-reinstall \
            "scipy==1.11.4" \
            "jax==0.4.26" "jaxlib==0.4.26"

          # Сначала TFJS 4.11.0 (с jax-конвертером)
          pip install "tensorflowjs==4.11.0" || true

          # Проверка Strategy A
          python - <<'PY' || (echo "Strategy A failed" && touch /tmp/strategy_a_failed)
          import numpy as np
          from jax.experimental import jax2tf  # noqa: F401
          import tensorflowjs as tfjs
          import tensorflow as tf
          print("NumPy:", np.__version__, "| TF:", tf.__version__, "| TFJS:", tfjs.__version__)
          # быстрый smoke тест TF
          a,b = tf.constant([1.0]), tf.constant([2.0]); _ = a + b
          print("✅ Strategy A imports OK")
          PY

          if [ -f /tmp/strategy_a_failed ]; then
            echo "=== Strategy B: TFJS 4.10.0 + JAX (на тот же пин) ==="
            pip uninstall -y tensorflowjs || true
            pip install "tensorflowjs==4.10.0" || true

            python - <<'PY' || (echo "Strategy B failed" && touch /tmp/strategy_b_failed)
            import numpy as np
            from jax.experimental import jax2tf  # noqa: F401
            import tensorflowjs as tfjs
            import tensorflow as tf
            print("NumPy:", np.__version__, "| TF:", tf.__version__, "| TFJS:", tfjs.__version__)
            a,b = tf.constant([1.0]), tf.constant([2.0]); _ = a + b
            print("✅ Strategy B imports OK")
            PY
          fi

          if [ -f /tmp/strategy_a_failed ] && [ -f /tmp/strategy_b_failed ]; then
            echo "=== Strategy C: TFJS 4.8.0 БЕЗ JAX-конвертера (надёжный фоллбек) ==="
            pip uninstall -y tensorflowjs jax jaxlib || true
            pip install --no-deps "tensorflowjs==4.8.0"

            # На всякий случай закрепим NumPy<2 обратно
            pip install --upgrade --force-reinstall "numpy==1.23.5"

            python - <<'PY'
            import numpy as np
            import tensorflowjs as tfjs
            import tensorflow as tf
            print("NumPy:", np.__version__, "| TF:", tf.__version__, "| TFJS:", tfjs.__version__)
            a,b = tf.constant([1.0]), tf.constant([2.0]); _ = a + b
            print("✅ Strategy C imports OK")
            PY
          fi

      - name: Convert model to TFJS (if present)
        run: |
          set -euxo pipefail
          mkdir -p public/web_model

          # Если есть SavedModel:
          if [ -d "saved_model" ]; then
            python - <<'PY'
            import tensorflow as tf, tensorflowjs as tfjs
            import os
            src = "saved_model"
            dst = "public/web_model/savedmodel"
            os.makedirs(dst, exist_ok=True)
            tfjs.converters.convert_tf_saved_model(src, dst)
            print("✅ Converted SavedModel →", dst)
            PY
          fi

          # Если есть Keras H5:
          if [ -f "model.h5" ]; then
            python - <<'PY'
            import tensorflow as tf, tensorflowjs as tfjs
            import os
            model = tf.keras.models.load_model("model.h5")
            dst = "public/web_model/keras_h5"
            os.makedirs(dst, exist_ok=True)
            tfjs.converters.save_keras_model(model, dst)
            print("✅ Converted Keras H5 →", dst)
            PY
          fi

          # Если есть Keras SavedModel (.keras):
          if ls *.keras >/dev/null 2>&1; then
            F=$(ls *.keras | head -n1)
            python - <<'PY'
            import tensorflow as tf, tensorflowjs as tfjs
            import glob, os
            keras_files = glob.glob("*.keras")
            if not keras_files:
              raise SystemExit(0)
            f = keras_files[0]
            model = tf.keras.models.load_model(f)
            dst = "public/web_model/keras"
            os.makedirs(dst, exist_ok=True)
            tfjs.converters.save_keras_model(model, dst)
            print("✅ Converted Keras .keras →", dst)
            PY
          fi

          echo "ℹ️ Если моделей нет — конвертация пропущена (это нормально). Окружение настроено."

      - name: Upload web model artifact (if any)
        uses: actions/upload-artifact@v4
        with:
          name: web_model
          path: public/web_model
          if-no-files-found: warn
