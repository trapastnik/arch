name: build

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      PIP_NO_PYTHON_VERSION_WARNING: "1"
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Upgrade pip tooling
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip setuptools wheel
          python - <<'PY'
          import pip, pkgutil
          print(f"✅ Pip OK: {pip.__version__}")
          PY

      - name: Install base (TF 2.12.0 + NumPy 1.23.5 compatible pins)
        run: |
          set -euxo pipefail
          # Strict pins that are known-good with TF 2.12.0 on Py3.10
          pip install \
            numpy==1.23.5 \
            h5py==3.10.0 \
            packaging==23.2 \
            typing_extensions==4.5.0 \
            protobuf==3.20.3
          pip install \
            tensorflow-cpu==2.12.0 \
            tensorflow-estimator==2.12.0 \
            tensorboard==2.12.3
          python - <<'PY'
          import numpy as np, tensorflow as tf
          print("✅ Base OK | NumPy:", np.__version__, "| TF:", tf.__version__)
          PY

      - name: Install TFJS converter deps (no heavy transitive deps)
        run: |
          set -euxo pipefail
          # Extras required by tensorflowjs converters, installed without pulling newer TF/JAX
          pip install --no-deps tensorflow-decision-forests==1.4.0
          pip install --no-deps tensorflow-hub==0.12.0
          pip install --no-deps tensorflowjs==4.8.0
          python - <<'PY'
          import numpy as np, tensorflow as tf, tensorflowjs as tfjs
          # Make sure converter submodules import (they import tfdf and hub)
          from tensorflowjs.converters import tf_saved_model_conversion_v2 as _conv
          a, b = tf.constant([1.]), tf.constant([2.]); _ = a + b
          print("✅ TFJS import OK | NumPy", np.__version__, "| TF", tf.__version__, "| TFJS", tfjs.__version__)
          PY

      - name: (Optional) Convert SavedModel to TFJS if model exists
        run: |
          set -euxo pipefail
          # Change these paths to your actual SavedModel dir and output dir
          SRC_MODEL_DIR="model/saved_model"
          OUT_DIR="public/web_model"
          if [ -d "$SRC_MODEL_DIR" ]; then
            mkdir -p "$OUT_DIR"
            python - <<'PY'
            import tensorflow as tf, tensorflowjs as tfjs, os
            src = os.environ.get("SRC_MODEL_DIR")
            dst = os.environ.get("OUT_DIR")
            tfjs.converters.convert_tf_saved_model(src, dst)
            print("✅ Converted SavedModel -> TFJS at", dst)
            PY
          else
            echo "ℹ️ No SavedModel found at ${SRC_MODEL_DIR}; skipping conversion."
          fi

      - name: Upload web_model artifact (if created)
        if: ${{ hashFiles('public/web_model/**') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: web_model
          path: public/web_model
