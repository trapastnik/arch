name: build-and-deploy
on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: List repo (debug)
        run: |
          pwd
          ls -lah
          ls -lah .github/workflows || true

      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install deps (stable pins)
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip setuptools wheel
          # пины, с которыми TF 2.13 конвертит без конфликтов
          pip install "numpy<2" "h5py<3.11" "protobuf<4.24" "packaging>=23" "typing_extensions>=4.5"
          pip install "tensorflow-cpu==2.13.1"
          pip install "tensorflowjs==3.21.0"
          python - <<'PY'
          import sys, tensorflow as tf, tensorflowjs, numpy, h5py, pkgutil
          print("PY:", sys.version)
          print("TF:", tf.__version__)
          print("TFJS:", tensorflowjs.__version__)
          print("numpy:", numpy.__version__)
          print("h5py:", h5py.__version__)
          print("keras backend:", tf.keras.backend.backend())
          PY

      - name: Convert Keras -> TFJS
        run: |
          set -euxo pipefail
          test -f model_final.keras || (echo "❌ model_final.keras not found in repo root" && exit 1)
          python - <<'PY'
          import os, tensorflow as tf, tensorflowjs as tfjs
          src = "model_final.keras"  # если файл другой — замени это имя!
          out = "site/web_model"
          os.makedirs(out, exist_ok=True)
          print("Loading:", os.path.abspath(src))
          m = tf.keras.models.load_model(src, compile=False)
          print("Saving TFJS to:", os.path.abspath(out))
          tfjs.converters.save_keras_model(m, out)
          print("Saved:", os.listdir(out))
          PY
          ls -lah site/web_model

      - name: Assemble site
        run: |
          set -euxo pipefail
          mkdir -p site
          cp index.html site/
          cp class_mapping.json site/
          echo "Site tree:"
          find site -maxdepth 2 -type f -ls

      - uses: actions/configure-pages@v5
      - uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4
